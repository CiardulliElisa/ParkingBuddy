<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <link rel="stylesheet" href="css/styles.css?v=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
</head>
<body>
<header>
    <h1>ParkingBuddy</h1>
</header>
<div class="container">
    <div class="map">
        <div id="map"></div>
    </div>
    <div class="parkingStations mt-4">
        <label for="parkingDropdown">Select Parking Station:</label>
        <select id="parkingDropdown" class="form-select mb-3">
            <option value="">Select a station</option>
            <option th:each="name : ${stationNames}" th:value="${name}" th:text="${name}"></option>
        </select>

        <form th:action="@{/home}" method="post">
            <label>Select the day for a prediction: </label>
            <br>
            <input type="date" onfocus="this.showPicker()" name="date">
            <button  type="submit" class="predict">Predict</button>
        </form>
        <br>
        <div id="chart" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
        <div style="display: block;">
            <table id="predictionTable" style="border: 1px solid black">
                <thead>
                    <tr>
                        <th style="width: 150px; border: 1px solid black">Hour [0-23]</th>
                        <th style="width: 150px; border: 1px solid black">Free slots [number]</th>
                    </tr>
                </thead>
            </table>
        </div>

    </div>
    <div>

    </div>
    <p id="loading" style="display:none;">Loading...</p>
    <div id="stationInfo" class="mt-3"></div>
</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
<script th:inline = "javascript">
    var prediction = /*[[${prediction}]]*/ [];
    document.addEventListener('DOMContentLoaded', function () {
        prediction.forEach(point => {
            var time = point.timestamp.toString().substring(0,13);
            insRow('predictionTable', time, point.freeSlots);});
        function insRow(id, hour, pred){
            var x = document.getElementById(id).insertRow(1);
            var y = x.insertCell(0);
            var z = x.insertCell(1);
            y.innerHTML = hour;
            y.style.border = "1px solid black";
            z.innerHTML = pred;
            z.style.border = "1px solid black";
        }});
</script>

<script>
    const map = L.map('map').setView([46.638780, 11.350111], 9);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    fetch('/api/points')
        .then(response => response.json())
        .then(data => {
            data.forEach(point => {
                L.marker([point.lat, point.lng])
                    .addTo(map)
                    .bindPopup(point.name);
            });
        })
        .catch(error => console.error('Error loading markers:', error));
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dropdown = document.getElementById('parkingDropdown');
        const infoDiv = document.getElementById('stationInfo');
        const loading = document.getElementById('loading');

        dropdown.addEventListener('change', function () {
            const selectedName = this.value;

            if (!selectedName) return;

            loading.style.display = 'block';
            infoDiv.innerHTML = '';

            fetch(`/api/stationData?name=${encodeURIComponent(selectedName)}`)
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';

                    if (data) {
                        console.log(data)
                        console.log("Timestamps:", data.timestamps);
                        console.log("Free spots:", data.free_spots);
                        const firstTimestamp = data.timestamps[0]; // The most recent timestamp
                        const firstValue = data.free_spots[0];  // Value for the most recent timestamp


                        // Update UI
                        infoDiv.innerHTML = `
                            <div class="card mt-3">
                                <div class="card-body">
                                    <h5 class="card-title">${data.name}</h5>
                                    <p class="card-text"><strong>Code:</strong> ${data.code}</p>
                                    <p class="card-text"><strong>Municipality:</strong> ${data.municipality}</p>
                                    <p class="card-text"><strong>Capacity:</strong> ${data.capacity}</p>
                                    <p class="card-text"><strong>Period:</strong> ${data.period} minutes</p>
                                    <p class="card-text"><strong>Coordinates:</strong> (${data.coordinates.y}, ${data.coordinates.x})</p>
                                    <p class="card-text"><strong>Most Recent Free Spots:</strong> ${firstValue}</p>
                                    <p class="card-text"><strong>Most Recent Timestamp:</strong> ${firstTimestamp}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        infoDiv.innerHTML = `<p>No data available for this station.</p>`;
                    }
                })
                .catch(error => {
                    loading.style.display = 'none';
                    infoDiv.innerHTML = `<p>Error loading station data.</p>`;
                    console.error(error);
                });
        });
    });

</script>

<script th:inline = "javascript">
    var dataPoints = /*[[${dataPoints}]]*/ [];
    Highcharts.chart('chart', {
        title: {
            text: 'Line Chart Example'
        },
        xAxis: {
            categories: dataPoints.map(function(point) {
                return point.timestamp;
            })
        },
        yAxis: {
            title: {
                text: 'Value'
            }
        },
        series: [{
            type: 'line',
            name: 'Line 1',
            data: dataPoints.map(function(point) {
                return point.freeSlots;
            })
        }]
    });
</script>
</body>
</html>