<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParkingBuddy</title>
    <link rel="stylesheet" href="css/styles.css?">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <style>
        #map {
            height: 92%;
            width: 100%;
        }
    </style>
</head>
<body>
    <header>
        <h1>ParkingBuddy</h1>
    </header>

    <div class="container">
        <div class="row w-100 h-100">
            <div class="col-md-6 mb-3">
                <div class="card h-100 map">
                    <div class="card-body p-0">
                        <div id="map"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-3">
                <div class="card h-100 parkingStations">
                    <div class="card-body">
                        <label for="parkingDropdown" class="form-label">Select Parking Station:</label>
                        <select id="parkingDropdown" class="form-select mb-3">
                            <option value="">Select a station</option>
                            <option th:each="station : ${allStations}" th:value="${station.getName()}" th:text="${station.getName()}"></option>
                        </select>

                        <p id="loading" style="display:none;">Loading...</p>
                        <div id="stationInfo" class="mt-3"></div>
                    </div>
                    <form th:action="@{/home}" method="post">
                        <label>
                            Select the day for a prediction:
                        </label>
                        <br>
                        <input type="date" onfocus="this.showPicker()" name="date">
                        <button  type="submit" class="predict">
                            Predict
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
    <script>
        const map = L.map('map').setView([46.638780, 11.350111], 9);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        fetch('/api/points')
            .then(response => response.json())
            .then(data => {
                data.forEach(point => {
                    L.marker([point.lat, point.lng])
                        .addTo(map)
                        .bindPopup(point.name);
                });
            })
            .catch(error => console.error('Error loading markers:', error));
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const dropdown = document.getElementById('parkingDropdown');
            const infoDiv = document.getElementById('stationInfo');
            const loading = document.getElementById('loading');

            dropdown.addEventListener('change', function () {
                const selectedName = this.value;

                if (!selectedName) return;

                loading.style.display = 'block';
                infoDiv.innerHTML = '';

                fetch(`/api/stationData?name=${encodeURIComponent(selectedName)}`)
                    .then(response => response.json())
                    .then(data => {
                        loading.style.display = 'none';

                        if (data) {
                            console.log(data)
                            console.log("Timestamps:", data.timestamps);
                            console.log("Free spots:", data.free_spots);
                            const firstTimestamp = data.timestamps[0];
                            const firstValue = data.free_spots[0];

                            const timestampDate = new Date(firstTimestamp);
                            const now = new Date();
                            const diffMs = now - timestampDate; // Difference in milliseconds

                            // Convert to human-readable time ago
                            let timeAgo;
                            const diffSec = Math.floor(diffMs / 1000);
                            const diffMin = Math.floor(diffSec / 60);
                            const diffHours = Math.floor(diffMin / 60);
                            const diffDays = Math.floor(diffHours / 24);

                            let infoHTML = `
                                <div class="card mt-3">
                                    <div class="card-body">
                                        <h5 class="card-title">${data.name}</h5>
                                        <p class="card-text"><strong>Municipality:</strong> ${data.municipality}</p>
                                        <p class="card-text"><strong>Capacity:</strong> ${data.capacity}</p>
                            `;

                            if (diffHours > 10) {
                                // No real-time data available, hide the timestamp and free spots line
                                infoHTML += `<p class="card-text" style="color: red;">No real-time data available for this station.</p>`;
                            } else {
                                // Display the "Most Recent Free Spots" and "Last Updated" info
                                infoHTML += `<p class="card-text"><strong>Most Recent Free Spots:</strong> ${firstValue}</p>`;

                                if (diffDays > 0) {
                                    timeAgo = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                                } else if (diffHours > 0) {
                                    timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                                } else if (diffMin > 0) {
                                    timeAgo = `${diffMin} minute${diffMin > 1 ? 's' : ''} ago`;
                                } else {
                                    timeAgo = `${diffSec} second${diffSec !== 1 ? 's' : ''} ago`;
                                }

                                infoHTML += `<p class="card-text"><strong>Last Updated:</strong> ${timeAgo}</p>`;
                            }

                            infoHTML += `</div></div>`;

                            infoDiv.innerHTML = infoHTML; // This should be inside the .then block
                        }
                    })
                    .catch(error => {
                        loading.style.display = 'none';
                        infoDiv.innerHTML = `<p>Error loading station data.</p>`;
                        console.error(error);
                    });
            });
        });
    </script>
</body>
</html>